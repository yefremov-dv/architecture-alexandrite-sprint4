# Task 4
---
### Проанализируйте диаграмму системы и её описание.

> Решите, какую часть системы имеет смысл закешировать.

Внедрение кеширования для новых заказов в MES. За отображение перечня заказов в MES отвечает MES API, а сам перечень всех заказов берется из MES DB. Вместе с тем, есть возможность забирать перечень новых заказов и RabbitMQ, вообще не обращаясь к MES DB. Необходимо принятие решение об архитектурной развилке. (см Achitectural Decision Records ниже)

**Achitectural Decision Records (далее - ADR):**
Проанализировали требования от операторов производства:
- Необходимо видеть новые заказы
- Вместе с тем необходимо понимать общий перечень заказов
- Сервис должен быть всегда доступен даже при отказе RabbitMQ

Было принято решение отказаться от кеширования очереди новых заказов из Message Queue. Кеширование итогового перечня заказов, включая новые со специальным статусом, решено реализовать между MES DB и MES API.

Кешируются только список заказов и статус. Необходимо произвести рефакторинг первой страницы MES: в начале будут отображаться список заказов со статусом NEW, затем список со всеми остальными заказами. Оба перечня берутся из кеша. Т.к. модель отображаемых данных для операторов будет отличаться от используемой MES DB и недоступностимо простаивание производственного конвейра из-за отключения модуля кеширования, то принято решение использовать паттерн Cache-Aside. Риск неконсистентности данных нивелируем дополнительными 10 минутами, когда заказ "охлаждается" после подтверждения от Seller в CRM для минимизации ситуаций, когда клиент передумывает и/или отменяет заказ.

---
### Добавьте в файл раздел «Мотивация».

> Опишите здесь, почему вы предлагаете внедрить кеширование, какие проблемы оно должно решить и какие элементы системы вы планируете включить в кеширование.

Ключевые жалобы на производстве связаны с долгим открытием MES страницы с заказами, что не позволяет брать заказ в работу операторам и напрямую влияет на выручку компании.
Кеширование позволит значительно ускорить открытие стартовой страницы, но т.к. бюджет на ИТ ограничен, принято решение о кешировании только самых необходимых данных по согласованию с операторами производства.

Условия:
- Внедрение кеширования для новых заказов в MES.
- Кешируются только список заказов и статус.

---
### Добавьте раздел «Предлагаемое решение».

> Определите, какое кеширование вы будете внедрять — клиентское или серверное. Объясните, почему, на ваш взгляд, нужно использовать именно его. Если вы решите куда-то внедрить серверное кеширование, то поясните, какой паттерн будете применять — Cache-Aside, Write-Through или Refresh-Ahead. А также объясните, почему вы выбрали этот паттерн и почему остальные паттерны не подойдут или покажут себя хуже.

**Achitectural Decision Records (далее - ADR):**
Проанализировали требования от операторов производства:
- Необходимо видеть новые заказы
- Вместе с тем необходимо понимать общий перечень заказов
- Сервис должен быть всегда доступен даже при отказе RabbitMQ

**Итоги ADR**
1. Было принято решение отказаться от кеширования очереди новых заказов из Message Queue с учетом требований доступности первой страницы MES даже при отключенных других сервисах компании вне MES систем
2. Кеширование итогового перечня заказов, включая новые со специальным статусом, решено реализовать между MES DB и MES API. MES будет отображать данные, полученные через модуль MES API.
3. Используется только серверное кеширование, потребности в клиентском отсутствует
4. Необходимо произвести рефакторинг первой страницы MES: в начале будут отображаться список заказов со статусом NEW, затем список со всеми остальными заказами.
5. Оба перечня берутся из кеша.
6. Принято решение использовать паттерн Cache-Aside, т.к. данный паттерн отвечает ключевым требованиям: 
    - Модель отображаемых данных для операторов будет отличаться от используемой MES DB
    - Недоступностимо простаивание производственного конвейра из-за отключения модуля кеширования.
    - Основные жалобы операторов направлены именно на чтение информации из MES DB. К записи глобальных вопросов нет
    - Риск неконсистентности данных нивелируем дополнительными 10 минутами, когда заказ "охлаждается" после подтверждения от Seller в CRM для минимизации ситуаций, когда клиент передумывает и/или отменяет заказ.
    - При недоступности CRM оператор видит соответствующий индикатор на заказе о отсутствии детализации из CRM, что за 10 минут с момента заказа клиент не перезвонил с уточнениями.
    - Дополнительно (при финансовой возможности) рассмотрим вариант с репликацией кеша

Прочие паттерны кеширования не соответствуют всем заявленным требованиям  от бизнес и ИТ-команды "Александрита" (пункт #6 ADR).

**Инвалидация кеша**
С учетом согласования бизнес-подразделением периода охлаждения в 10 минут после утвеждения заявки менеджером по продажам, была выбрана временная инвалидация кеша. Кеш обновляется каждые 5 минут, что на объемах "Александрита" не создаст дополнительной значительной нагрузки на MES DB.
Для удобства операторов, чтобы не получилось ситуация, когда два оператора за 5 минут берут один заказ, добавлен функционал в MES API, который напротив заказа проставляет метку "оператор начал анализ заказа". Вместе с тем данная метка не меняет статус заказа, т.к. оператор может отказаться от выполнения или нажать на заказ по ошибке.

---
### Нарисуйте диаграмму последовательности действий (Sequence diagram).

> Отобразите там, как проходит операция чтения списка заказов и запись об изменении статуса заказа. Там же опишите процесс кеширования с указанием всех сущностей, которые участвуют в кешировании. Добавьте диаграмму в раздел «Предлагаемое решение».

**Диаграмма последовательности действий** расположена в текущей директории под названием *"SDCache.puml"* или "SDCache.png"

---
### В блоке «Предлагаемое решение» опишите стратегию инвалидации кеша, которую вы планируете использовать.

> Объясните, какую стратегию инвалидации вы предлагаете (временную, по ключу, программную или другие), почему она подойдёт и почему не подойдут другие стратегии.
Не всегда очевидно, какое решение лучше. Чтобы выбрать оптимальный вариант, можете сделать сравнительный анализ в виде таблицы. 

См. последний пункт блока "Предлагаемое решение"

---